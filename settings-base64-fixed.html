<!-- Settings Page with Base64 Save/Load (Patched and Reliable) -->

<div style="max-width:360px;margin:20px auto;padding:15px;background:#101010;color:#fff;font-family:'Segoe UI',sans-serif;border-radius:12px;">

  <h3 style="color:#66f;text-align:center;">Settings</h3>

  <button onclick="generateSaveCode()" style="margin:10px;padding:10px 16px;background:#28a745;border:none;border-radius:8px;color:white;font-weight:bold;">
    Generate Save Code
  </button>

  <textarea id="saveCodeOutput" readonly style="width:100%;height:80px;margin-top:10px;background:#1a1a1a;color:#66f;border:none;border-radius:6px;padding:10px;"></textarea>

  <hr style="margin:20px 0;border:0;border-top:1px solid #333;">

  <textarea id="loadCodeInput" placeholder="Paste your save code here" style="width:100%;height:80px;background:#1a1a1a;color:#fff;border:none;border-radius:6px;padding:10px;"></textarea>

  <button onclick="loadSaveCode()" style="margin:10px;padding:10px 16px;background:#007bff;border:none;border-radius:8px;color:white;font-weight:bold;">
    Load Save Code
  </button>

  <hr style="margin:20px 0;border:0;border-top:1px solid #333;">

  <button onclick="resetGame()" style="margin:10px;padding:10px 16px;background:#dc3545;border:none;border-radius:8px;color:white;font-weight:bold;">
    Reset Game
  </button>

  <p id="notice" style="color:#aaa;text-align:center;margin-top:12px;"></p>

</div>

<script>
function generateSaveCode() {
  const statsRaw = JSON.parse(localStorage.getItem("stats") || "{}");
  const inventory = JSON.parse(localStorage.getItem("inventory") || "[]");
  const log = JSON.parse(localStorage.getItem("gameLog") || "[]");
  const completed = JSON.parse(localStorage.getItem("completedMissions") || "[]");

  const stats = {
    xp: statsRaw.xp || 0,
    cash: statsRaw.cash || 0,
    rep: statsRaw.rep || 0,
    heat: statsRaw.heat || 0
  };

  const saveData = {
    stats,
    inventory: Array.isArray(inventory) ? inventory : [],
    log: Array.isArray(log) ? log : [],
    completed: Array.isArray(completed) ? completed : []
  };

  const code = btoa(JSON.stringify(saveData));
  document.getElementById("saveCodeOutput").value = code;
  document.getElementById("notice").textContent = "Save code generated.";
}

function loadSaveCode() {
  try {
    const input = document.getElementById("loadCodeInput").value.trim();
    const decoded = JSON.parse(atob(input));

    localStorage.setItem("stats", JSON.stringify(decoded.stats || {}));
    localStorage.setItem("inventory", JSON.stringify(decoded.inventory || []));
    localStorage.setItem("gameLog", JSON.stringify(decoded.log || []));
    localStorage.setItem("completedMissions", JSON.stringify(decoded.completed || []));
    localStorage.setItem("statsUpdated", Date.now());

    document.getElementById("notice").textContent = "Game data loaded successfully.";
    window.dispatchEvent(new Event("storage"));
  } catch (e) {
    document.getElementById("notice").textContent = "Invalid or corrupted save code.";
  }
}

function resetGame() {
  localStorage.clear();
  document.getElementById("notice").textContent = "Game data reset.";
  window.dispatchEvent(new Event("storage"));
}
</script>
