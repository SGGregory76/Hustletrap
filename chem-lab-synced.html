<!-- Chem Lab with Craft Limits and Cooldown (Synced Version) -->

<div class="chem-lab-wrapper" style="max-width:360px;margin:20px auto;padding:15px;background:#0c0c0c;font-family:'Segoe UI',sans-serif;color:#fff;border-radius:12px;">

  <h3 style="text-align:center;">Chem Lab</h3>

  <div class="stats-bar" style="text-align:center;background:#000;padding:8px;margin:10px 0;border-radius:8px;">
    Level: <span id="level">?</span> |
    XP: <span id="xp">?</span> |
    REP: <span id="rep">?</span> |
    Heat: <span id="heat">?</span> |
    Cash: <span id="cash">?</span>
  </div>

  <div style="text-align:center;margin-bottom:10px;">Select two ingredients from inventory</div>

  <div id="labIcons" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;"></div>

  <div style="text-align:center;margin-top:10px;">
    <p><strong>Selected:</strong> <span id="selectedItems">None</span></p>
    <button onclick="mixIngredients()">Mix</button>
    <p id="resultBox" style="margin-top:10px;"></p>
  </div>
</div>

<style>
.chem-lab-wrapper button {
  margin-top: 5px;
  background-color: #333;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
}
.chem-lab-wrapper button:hover {
  background-color: #444;
}
</style>

<script>
let ingredients = [];

function getLevel(xp) {
  return Math.floor(xp / 10) + 1;
}
function getStats() {
  return JSON.parse(localStorage.getItem("stats")) || { xp: 0, rep: 0, cash: 0, heat: 0 };
}
function updateStatsUI() {
  const stats = getStats();
  const level = getLevel(stats.xp);
  document.getElementById("level").textContent = level;
  document.getElementById("xp").textContent = stats.xp;
  document.getElementById("rep").textContent = stats.rep;
  document.getElementById("heat").textContent = stats.heat;
  document.getElementById("cash").textContent = stats.cash;
}
function getInventory() {
  return JSON.parse(localStorage.getItem("inventory")) || [];
}
function getCraftHistory() {
  const data = JSON.parse(localStorage.getItem("craftHistory")) || {};
  const today = new Date().toDateString();
  if (data.date !== today) {
    data.records = {};
    data.date = today;
    localStorage.setItem("craftHistory", JSON.stringify(data));
  }
  return data.records || {};
}
function updateCraftHistory(resultName) {
  const data = JSON.parse(localStorage.getItem("craftHistory")) || { date: new Date().toDateString(), records: {} };
  data.records[resultName] = (data.records[resultName] || 0) + 1;
  localStorage.setItem("craftHistory", JSON.stringify(data));
}
function selectIngredient(icon) {
  if (ingredients.length < 2) {
    ingredients.push(icon);
    document.getElementById("selectedItems").textContent = ingredients.join(" + ");
  }
}
function addToInventory(name) {
  const inv = getInventory();
  inv.push({ name, desc: "Crafted in Chem Lab" });
  localStorage.setItem("inventory", JSON.stringify(inv));
}
function logEntry(message) {
  const logs = JSON.parse(localStorage.getItem("gameLog")) || [];
  logs.unshift({ time: new Date().toLocaleString(), message });
  localStorage.setItem("gameLog", JSON.stringify(logs));
}
function mixIngredients() {
  const stats = getStats();
  const combo = ingredients.join("");
  const history = getCraftHistory();
  let result = "Unknown Result";
  let requiredXP = 0;
  let dailyLimit = 1;

  if (combo === "üåøüåø") {
    result = "Custom Weed Strain";
    requiredXP = 0;
    dailyLimit = 2;
  } else if (combo === "üíä‚ùÑÔ∏è") {
    result = "Speedball";
    requiredXP = 10;
    dailyLimit = 1;
  } else if (combo === "üíâüîÆ") {
    result = "Trip Serum";
    requiredXP = 20;
    dailyLimit = 1;
  } else if (combo === "üß™üåø") {
    result = "Mutant Plant";
    requiredXP = 15;
    dailyLimit = 1;
  } else if (combo === "üíäüíâ") {
    result = "Nerve Blend";
    requiredXP = 25;
    dailyLimit = 1;
  }

  if (stats.xp < requiredXP) {
    document.getElementById("resultBox").innerHTML = `<span style='color:#f55;'>Need XP ${requiredXP} to craft ${result}.</span>`;
    return;
  }

  if ((history[result] || 0) >= dailyLimit) {
    document.getElementById("resultBox").innerHTML = `<span style='color:#f55;'>Daily limit reached for ${result}. Try again tomorrow.</span>`;
    return;
  }

  addToInventory(result);
  logEntry(`Crafted ${result} in the Chem Lab.`);
  updateCraftHistory(result);

  document.getElementById("resultBox").innerHTML = `<strong>Result:</strong> ${result}`;
  ingredients = [];
  document.getElementById("selectedItems").textContent = "";
  renderInventoryIcons();
}

function renderInventoryIcons() {
  const inventory = getInventory();
  const grid = document.getElementById("labIcons");
  const unique = [...new Set(inventory.map(i => i.name))];
  const iconMap = {
    "Marijuana": "üåø", "Adderall": "üíä", "Cocaine": "‚ùÑÔ∏è", "Oxytocin": "üíâ",
    "LSD": "üîÆ", "Unknown Compound": "üß™"
  };

  grid.innerHTML = unique.map(name => {
    const icon = iconMap[name] || "‚ùî";
    return `<div onclick="selectIngredient('${icon}')" style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;font-size:24px;background:#1d1d1d;border-radius:8px;cursor:pointer;">${icon}</div>`;
  }).join("");
}

document.addEventListener("DOMContentLoaded", () => {
  updateStatsUI();
  renderInventoryIcons();
});
window.addEventListener("storage", (e) => {
  if (e.key === "statsUpdated" || e.key === "gameReset") updateStatsUI();
});
</script>
