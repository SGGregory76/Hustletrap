<!-- Main Mission System with Universal NPC Economy -->

<div style="max-width:360px;margin:20px auto;padding:15px;background:#0f0f0f;font-family:'Segoe UI',sans-serif;color:#fff;border-radius:12px;">
  <h3 style="text-align:center;margin-bottom:15px;">Available Missions</h3>

  <div style="text-align:center;margin-bottom:10px;">
    <strong>Level:</strong> <span id="level">?</span> |
    <strong>XP:</strong> <span id="xp">?</span> |
    <strong>REP:</strong> <span id="rep">?</span> |
    <strong>Heat:</strong> <span id="heat">?</span> |
    <strong>Cash:</strong> <span id="cash">?</span>
  </div>

  <select id="npcSelect" onchange="renderNPC(this.value)" style="width:100%;padding:6px;border-radius:6px;background:#1a1a1a;color:#fff;margin-bottom:10px;">
    <option value="0">Rico (Enforcer)</option>
    <option value="1">Maya (Courier)</option>
    <option value="2">Lex (Chemist)</option>
  </select>

  <div id="npcMissions"></div>
</div>

<script>
const npcs = [
  {
    name: "Rico",
    missions: [
      { id: "rico1", title: "Protect Turf", reward: { name: "Marijuana", icon: "üåø" }, xp: 5, rep: 4, unlockRep: 0 },
      { id: "rico2", title: "Intercept Deal", reward: { name: "Cocaine", icon: "‚ùÑÔ∏è" }, xp: 7, rep: 5, unlockRep: 10 }
    ]
  },
  {
    name: "Maya",
    missions: [
      { id: "maya1", title: "Night Drop", reward: { name: "LSD", icon: "üîÆ" }, xp: 6, rep: 4, unlockRep: 5 },
      { id: "maya2", title: "Extended Route", reward: { name: "Adderall", icon: "üíä" }, xp: 8, rep: 6, unlockRep: 12 }
    ]
  },
  {
    name: "Lex",
    missions: [
      { id: "lex1", title: "Test Sample", reward: { name: "Unknown Compound", icon: "üß™" }, xp: 5, rep: 5, unlockRep: 0 },
      { id: "lex2", title: "Formula Delivery", reward: { name: "Oxytocin", icon: "üíâ" }, xp: 10, rep: 7, unlockRep: 10 }
    ]
  }
];

function getLevel(xp) {
  return Math.floor(xp / 10) + 1;
}

function getStats() {
  return JSON.parse(localStorage.getItem("stats")) || { xp: 0, rep: 0, cash: 0, heat: 0 };
}

function setStats(stats) {
  localStorage.setItem("stats", JSON.stringify(stats));
  localStorage.setItem("playerLevel", getLevel(stats.xp));
  localStorage.setItem("statsUpdated", Date.now());
  updateStatsUI();
}

function getCompleted() {
  return JSON.parse(localStorage.getItem("completedMissions")) || [];
}

function saveCompleted(list) {
  localStorage.setItem("completedMissions", JSON.stringify(list));
}

function addToInventory(name, icon) {
  const inv = JSON.parse(localStorage.getItem("inventory")) || [];
  inv.push({ name: name, icon: icon, desc: "Mission reward" });
  localStorage.setItem("inventory", JSON.stringify(inv));
}

function logEntry(message) {
  const logs = JSON.parse(localStorage.getItem("gameLog")) || [];
  logs.unshift({ time: new Date().toLocaleString(), message });
  localStorage.setItem("gameLog", JSON.stringify(logs));
}

function completeMission(npcIndex, missionIndex) {
  const npc = npcs[npcIndex];
  const mission = npc.missions[missionIndex];
  const stats = getStats();
  const completed = getCompleted();

  if (completed.includes(mission.id)) return;

  stats.xp += mission.xp;
  stats.rep += mission.rep;

  setStats(stats);
  completed.push(mission.id);
  saveCompleted(completed);

  addToInventory(mission.reward.name, mission.reward.icon);
  logEntry(`${npc.name}'s mission "${mission.title}" completed. Gained ${mission.reward.icon} ${mission.reward.name}, XP +${mission.xp}, REP +${mission.rep}`);
  renderNPC(npcIndex);
}

function renderNPC(index) {
  const npc = npcs[index];
  const stats = getStats();
  const completed = getCompleted();
  const div = document.getElementById("npcMissions");

  let html = `<h4>${npc.name}'s Missions</h4>`;
  npc.missions.forEach((m, i) => {
    const isUnlocked = stats.rep >= m.unlockRep;
    const done = completed.includes(m.id);

    html += `<div style="background:#1a1a1a;padding:10px;margin-bottom:10px;border-radius:8px;">
        <strong>${m.title}</strong><br>
        Reward: ${m.reward.icon} ${m.reward.name}<br>
        XP: ${m.xp}, REP: ${m.rep}<br>
        ${!isUnlocked ? `<em style='color:#aaa;'>Requires REP ${m.unlockRep}</em>` :
        done ? `<span style='color:#888;'>Completed</span>` :
        `<button onclick="completeMission(${index}, ${i})" style="margin-top:5px;padding:5px 10px;background:#28a745;border:none;border-radius:5px;color:#fff;">Complete</button>`}
      </div>`;
  });

  div.innerHTML = html;
  updateStatsUI();
}

function updateStatsUI() {
  const stats = getStats();
  const level = getLevel(stats.xp);
  document.getElementById("level").textContent = level;
  document.getElementById("xp").textContent = stats.xp;
  document.getElementById("rep").textContent = stats.rep;
  document.getElementById("heat").textContent = stats.heat;
  document.getElementById("cash").textContent = stats.cash;
}

document.addEventListener("DOMContentLoaded", () => renderNPC(0));
</script>
