<!DOCTYPE html>
<html>
<head>
  <title>Maya - Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #101010; color: white; font-family: sans-serif; padding: 20px; margin: 0; }
    .container { max-width: 400px; margin: auto; }
    h2, h4 { text-align: center; }
    .slot-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .slot { background: #1a1a1a; padding: 10px; border-radius: 8px; text-align: center; min-height: 60px; }
    button { background: #333; color: white; border: none; padding: 6px 10px; margin-top: 5px; border-radius: 6px; cursor: pointer; }
    button:hover { background: #444; }
    select { background: #222; color: white; border-radius: 6px; padding: 6px; width: 100%; margin-top: 10px; }
    .buyback { margin-top: 20px; }
  </style>
  <script src="https://sggregory76.github.io/Hustletrap/global-logic-rp.js"></script>
</head>
<body>
<div class="container">
  <h2>Maya</h2>
  <h4>Role: Street Dealer</h4>

  <div>
    <strong>Mood:</strong> <span id="npcMood">Loading...</span><br>
    <strong>On Drug:</strong> <span id="npcDrug">Loading...</span><br>
    <strong>Behavior:</strong> <span id="npcBehavior">Loading...</span>
  </div>

  <div class="slot-grid" id="npcSlots"></div>

  <h4>Sell Maya an Item</h4>
  <select id="giveSelect"></select>
  <button onclick="giveToNPC()">Sell</button>

  <div class="buyback">
    <h4>Buy Back from Maya</h4>
    <select id="buySelect"></select>
    <button onclick="buyBackFromNPC()">Buy Back</button>
  </div>

  <div id="resultMessage" style="margin-top:15px;text-align:center;color:yellow;"></div>
</div>

<script>
let npcInventory = JSON.parse(localStorage.getItem("mayaInventory")) || [
  { name: "Marijuana", icon: "üåø", type: "drug" }
];

function calculateBehavior(mood, drug, stats) {
  if (mood === "Paranoid" && drug === "Adderall") return "Defensive, rejects low offers";
  if (mood === "Trusting" && drug === "Marijuana") return "Cooperative, fair deals";
  if (mood === "Desperate" && drug === "LSD") return "Unpredictable, may overpay";
  if (drug === "Xanax") return "Detached, avoids interaction";
  if (drug === "LSD") return "Dreamy, unreliable trades";
  return "Neutral, standard prices";
}

function updateNPCMood() {
  const stats = JSON.parse(localStorage.getItem("stats") || "{}");
  let mood = "Neutral";
  if ((stats.heat || 0) > 10) mood = "Paranoid";
  else if ((stats.rep || 0) > 30) mood = "Trusting";
  else if ((stats.cash || 0) < 100) mood = "Desperate";
  else mood = ["Neutral", "Focused", "Edgy", "Zoned"][Math.floor(Math.random() * 4)];

  const drugList = ["Marijuana", "Xanax", "LSD", "Adderall"];
  const drug = drugList[Math.floor(Math.random() * drugList.length)];

  localStorage.setItem("mayaMood", mood);
  localStorage.setItem("mayaDrug", drug);
  localStorage.setItem("mayaLastUpdate", Date.now());

  document.getElementById("npcMood").innerText = mood;
  document.getElementById("npcDrug").innerText = drug;
  document.getElementById("npcBehavior").innerText = calculateBehavior(mood, drug, stats);
}

function loadNPCMood() {
  const stats = JSON.parse(localStorage.getItem("stats") || "{}");
  const last = parseInt(localStorage.getItem("mayaLastUpdate") || 0);

  if (Date.now() - last > 300000 || !localStorage.getItem("mayaMood")) {
    updateNPCMood();
  } else {
    const mood = localStorage.getItem("mayaMood") || "Neutral";
    const drug = localStorage.getItem("mayaDrug") || "None";
    document.getElementById("npcMood").innerText = mood;
    document.getElementById("npcDrug").innerText = drug;
    document.getElementById("npcBehavior").innerText = calculateBehavior(mood, drug, stats);
  }
}

function saveInventory() {
  localStorage.setItem("mayaInventory", JSON.stringify(npcInventory));
}

function renderInventory() {
  const slots = document.getElementById("npcSlots");
  slots.innerHTML = "";
  for (let i = 0; i < 5; i++) {
    let slot = npcInventory[i] ? npcInventory[i].icon + " " + npcInventory[i].name : "Empty Slot";
    slots.innerHTML += `<div class="slot">${slot}</div>`;
  }
}

function renderGiveSelect() {
  const inv = JSON.parse(localStorage.getItem("inventory")) || [];
  const give = document.getElementById("giveSelect");
  give.innerHTML = inv.map((item, idx) => `<option value="${idx}">${item.icon || "‚ùî"} ${item.name}</option>`).join("") || "<option disabled>No Items</option>";
}

function renderBuySelect() {
  const buy = document.getElementById("buySelect");
  buy.innerHTML = npcInventory.map((item, idx) => `<option value="${idx}">${item.icon || "‚ùî"} ${item.name}</option>`).join("") || "<option disabled>No Items</option>";
}

function giveToNPC() {
  const idx = document.getElementById("giveSelect").value;
  if (idx === "" || idx == null) return;
  let playerInv = JSON.parse(localStorage.getItem("inventory")) || [];
  const item = playerInv.splice(idx, 1)[0];
  if (!item) return;

  if (npcInventory.length < 5) {
    npcInventory.push({ name: item.name, icon: item.icon, type: "drug" });
    localStorage.setItem("inventory", JSON.stringify(playerInv));
    saveInventory();
    renderInventory();
    renderGiveSelect();
    renderBuySelect();
    logEntry(`Sold ${item.name} to Maya.`);
    document.getElementById("resultMessage").innerText = "Item sold!";
  } else {
    document.getElementById("resultMessage").innerText = "No available slot!";
  }
}

function buyBackFromNPC() {
  const idx = document.getElementById("buySelect").value;
  if (idx === "" || idx == null) return;
  const item = npcInventory[idx];
  const priceMultiplier = 0.9 + Math.random() * 0.4;
  const price = Math.floor((drugValues[item.name] || drugValues["default"]) * priceMultiplier);
  const stats = JSON.parse(localStorage.getItem("stats") || "{}");
  if ((stats.cash || 0) < price) {
    document.getElementById("resultMessage").innerText = "Not enough cash!";
    return;
  }
  npcInventory.splice(idx, 1);
  updatePlayer("cash", -price);
  const playerInv = JSON.parse(localStorage.getItem("inventory")) || [];
  playerInv.push(item);
  localStorage.setItem("inventory", JSON.stringify(playerInv));
  saveInventory();
  renderInventory();
  renderGiveSelect();
  renderBuySelect();
  logEntry(`Bought ${item.name} back from Maya for $${price}`);
  document.getElementById("resultMessage").innerText = `Bought for $${price}`;
}

function updatePlayer(stat, amount) {
  const s = JSON.parse(localStorage.getItem("stats") || "{}");
  s[stat] = (s[stat] || 0) + amount;
  localStorage.setItem("stats", JSON.stringify(s));
  localStorage.setItem("statsUpdated", Date.now());
}

function logEntry(message) {
  const logs = JSON.parse(localStorage.getItem("gameLog") || []);
  logs.unshift({ time: new Date().toLocaleString(), message });
  localStorage.setItem("gameLog", JSON.stringify(logs));
}

document.addEventListener("DOMContentLoaded", () => {
  loadNPCMood();
  renderInventory();
  renderGiveSelect();
  renderBuySelect();
  setInterval(npcAutoSellOrUse, 15000);
});

const drugValues = {
  "Marijuana": 20, "Cocaine": 60, "LSD": 40, "Adderall": 30, "Oxytocin": 45,
  "Unknown Compound": 35, "Speedball": 70, "Trip Serum": 65, "Nerve Blend": 50,
  "Meth": 55, "Crack": 45, "Mutant Plant": 25, "Custom Weed Strain": 35,
  "default": 30
};

function npcAutoSellOrUse() {
  const stats = JSON.parse(localStorage.getItem("stats") || "{}");
  const repScale = Math.floor((stats.rep || 0) / 10);
  const cashScale = Math.floor((stats.cash || 0) / 500);
  const sellLimit = 1 + repScale + cashScale;
  let soldCount = 0;

  for (let i = npcInventory.length - 1; i >= 0 && soldCount < sellLimit; i--) {
    const item = npcInventory[i];
    if (item.type === "drug") {
      const value = drugValues[item.name] || drugValues["default"];
      if (Math.random() < 0.7) {
        npcInventory.splice(i, 1);
        updatePlayer("cash", value);
        updatePlayer("heat", 1);
        updatePlayer("rep", 1);
        updatePlayer("xp", 2);
        awardRPSale(item.name);
        logEntry(`Maya sold ${item.name}.`);
      } else {
        npcInventory.splice(i, 1);
        updatePlayer("cash", value);
        updatePlayer("heat", 1);
        updatePlayer("rep", 1);
        updatePlayer("xp", 2);
        awardRPUse(item.name);
        logEntry(`Maya used ${item.name}.`);
      }
      soldCount++;
    }
  }
  saveInventory();
  renderInventory();
  renderBuySelect();
}
</script>
</body>
</html>
